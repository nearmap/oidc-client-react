{"version":3,"sources":["../src/index.js"],"names":["React","PropTypes","jwtDecode","UserManager","location","history","setupExpiryWorkaround","containsAccessToken","containsIdToken","defaultSinginRetries","Oidc","Component","setupEventDispatchers","events","userManager","addUserLoaded","user","handleUserLoaded","addUserUnloaded","handle","props","onUserUnloaded","addSilentRenewError","err","onSilentRenewError","addAccessTokenExpired","onUserExpired","addAccessTokenExpiring","onUserExpiring","signinSilent","onSigninError","signinSilentWithRetries","signinRetries","retryStep","checkTokenUrl","url","signinRedirectCallback","onTokenError","signinRedirect","args","onSigninRedirectError","signoutRedirect","onSignoutRedirectError","handler","handleUserExpired","accessToken","access_token","claims","state","undefined","charAt","JSON","parse","hash","stateToUrl","pathname","replaceState","onUserLoaded","componentDidMount","config","test","componentDidUpdate","needsLogin","needsLogout","render","object","string","number","bool","func"],"mappings":"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","sourcesContent":["import React from 'react';\nimport PropTypes from 'prop-types';\nimport jwtDecode from 'jwt-decode';\nimport {UserManager} from 'oidc-client/lib/oidc-client';\n\nimport {location, history} from './globals';\n\nimport setupExpiryWorkaround from './expiry-workaround.js';\n\n\nconst containsAccessToken = /\\baccess_token=.+/;\nconst containsIdToken = /\\bid_token=.+/;\nconst defaultSinginRetries = 5;\n\n\nexport default class Oidc extends React.Component {\n  static propTypes = {\n    config: PropTypes.object,\n    url: PropTypes.string,\n    signinRetries: PropTypes.number,\n    state: PropTypes.string,\n    needsLogin: PropTypes.bool,\n    needsLogout: PropTypes.bool,\n    stateToUrl: PropTypes.func,\n    onUserLoaded: PropTypes.func,\n    onUserExpired: PropTypes.func,\n    onUserExpiring: PropTypes.func,\n    onUserUnloaded: PropTypes.func,\n    onSigninError: PropTypes.func,\n    onSigninRedirectError: PropTypes.func,\n    onSignoutRedirectError: PropTypes.func,\n    onSilentRenewError: PropTypes.func,\n    onTokenError: PropTypes.func\n  };\n\n  setupEventDispatchers() {\n    const {events} = this.userManager;\n\n    events.addUserLoaded((user)=> this.handleUserLoaded(user));\n    events.addUserUnloaded(()=> this.handle(this.props.onUserUnloaded));\n    events.addSilentRenewError(\n      (err)=> this.handle(this.props.onSilentRenewError, err)\n    );\n    // TODO: should we automatically signin in like we do with the workaround?\n    events.addAccessTokenExpired(()=> this.handle(this.props.onUserExpired));\n    events.addAccessTokenExpiring(()=> this.handle(this.props.onUserExpiring));\n  }\n\n  async signinSilent() {\n    try {\n      await this.userManager.signinSilent();\n    } catch (err) {\n      this.handle(this.props.onSigninError, err);\n    }\n  }\n\n  async signinSilentWithRetries(signinRetries) {\n    let retryStep = 0;\n\n    while (retryStep < signinRetries) {\n      retryStep += 1;\n      try {\n        return await this.userManager.signinSilent();\n      } catch (err) {\n        // This may fail while the OS reconnects to a network\n        // after waking up and we were a bit too quick trying\n        // to perform the signin. We will retry a few times.\n        if (retryStep >= signinRetries) {\n          this.handle(this.props.onSigninError, err);\n        }\n      }\n    }\n  }\n\n  async checkTokenUrl(url) {\n    try {\n      await this.userManager.signinRedirectCallback(url);\n    } catch (err) {\n      this.handle(this.props.onTokenError, err);\n    }\n  }\n\n  async signinRedirect(...args) {\n    try {\n      await this.userManager.signinRedirect(...args);\n    } catch (err) {\n      this.handle(this.props.onSigninRedirectError, err);\n    }\n  }\n\n  async signoutRedirect() {\n    try {\n      await this.userManager.signoutRedirect();\n    } catch (err) {\n      this.handle(this.props.onSignoutRedirectError, err);\n    }\n  }\n\n  handle(handler, ...args) {\n    if (handler) {\n      handler(...args);\n    }\n  }\n\n  async handleUserExpired() {\n    const {onUserExpired, signinRetries} = this.props;\n\n    this.handle(onUserExpired);\n    await this.signinSilentWithRetries(signinRetries || defaultSinginRetries);\n  }\n\n  handleUserLoaded(user) {\n    const accessToken = user.access_token;\n    const claims = jwtDecode(accessToken);\n    let {state} = user;\n\n    if (state !== undefined) {\n      // check if state is a stringified json object which contains a\n      // `hash` field storing the URL hash fragment\n      if (state.charAt(0) === '{') {\n        state = JSON.parse(state);\n        state = state.hash;\n      }\n\n      // when we come back from a signinRedirect we should\n      // remove the token data from the URL and replace it with the\n      // state we had before the user was redirected away from the app\n      const url = typeof this.props.stateToUrl === 'function'\n        ? this.props.stateToUrl(state)\n        : `${location.pathname}${state}`;\n      history.replaceState(null, null, url);\n    }\n\n    this.handle(this.props.onUserLoaded, claims, accessToken);\n  }\n\n  componentDidMount() {\n    const {config, url} = this.props;\n    this.userManager = new UserManager(config);\n\n    this.setupEventDispatchers();\n    setupExpiryWorkaround(this.userManager, ()=> this.handleUserExpired());\n\n    if (containsAccessToken.test(url) && containsIdToken.test(url)) {\n      this.checkTokenUrl(url);\n    } else {\n      this.signinSilent();\n    }\n  }\n\n  componentDidUpdate() {\n    const {state, needsLogin, needsLogout} = this.props;\n\n    if (needsLogout) {\n      this.signoutRedirect();\n    }\n\n    if (needsLogin) {\n      this.signinRedirect({state});\n    }\n  }\n\n  render() {\n    return null;\n  }\n}\n"],"file":"index.js"}